---
# Maintenance playbook for updating Ansible configuration and Docker images
# This playbook pulls the latest Ansible config and updates Docker images
- name: Update Ansible configuration and Docker images
  hosts: "{{ target_host | default('all') }}"
  become: true

  vars:
    repo_url: >-
      {{
        maintenance_ansible_pull_repo_url |
        default(ansible_pull_repo_url) |
        default('https://github.com/DevSecNinja/docker.git')
      }}
    chezmoi_binary: >-
      {{ maintenance_chezmoi_binary | default('/usr/local/bin/chezmoi') }}
    workdir: >-
      {{
        maintenance_workdir |
        default(ansible_pull_workdir) |
        default('/var/lib/ansible/local')
      }}
    compose_base: >-
      {{ maintenance_compose_dirs | default(['/opt/docker-compose']) }}

  tasks:
    - name: Check for local changes in repository
      ansible.builtin.command:
        cmd: git -C {{ workdir }} status --porcelain
      register: git_status
      changed_when: false
      failed_when: false

    - name: Fail if local changes exist
      ansible.builtin.fail:
        msg: >-
          Local changes detected in {{ workdir }}.
          Commit or stash changes before running maintenance.
      when: git_status.stdout | length > 0

    - name: Pull latest Ansible configuration
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ workdir }}"
        version: main
        force: true
      register: git_pull_result

    - name: Display git pull result
      ansible.builtin.debug:
        msg: >-
          Ansible configuration updated:
          {{ 'Yes' if git_pull_result.changed else 'No changes' }}

    - name: Check if chezmoi is installed
      ansible.builtin.stat:
        path: "{{ chezmoi_binary }}"
      register: chezmoi_exists

    - name: Update chezmoi dotfiles
      become: true
      become_user: "{{ ansible_user }}"
      ansible.builtin.command: "{{ chezmoi_binary }} update"
      register: chezmoi_update
      changed_when: chezmoi_update.stdout | length > 0
      failed_when: false
      when:
        - ansible_user is defined
        - chezmoi_exists.stat.exists

    - name: Find all docker-compose.yml files
      ansible.builtin.find:
        paths: "{{ compose_base }}"
        patterns: "docker-compose.yml"
        recurse: true
      register: compose_files

    - name: Pull latest Docker images for all compose projects
      community.docker.docker_compose_v2_pull:
        project_src: "{{ item.path | dirname }}"
      loop: "{{ compose_files.files }}"
      register: docker_pull_result
      when: compose_files.files | length > 0

    - name: Restart Docker compose services if images were updated
      community.docker.docker_compose_v2:
        project_src: "{{ item.item.path | dirname }}"
        state: present
      loop: "{{ docker_pull_result.results | default([]) }}"
      loop_control:
        label: "{{ item.item.path }}"
      when:
        - compose_files.files | length > 0
        - docker_pull_result is defined
        - item.changed
