---
# Weekly maintenance playbook for full OS patches including reboot
# Runs on Saturday at 8 AM
- name: Weekly OS maintenance - Full patches with reboot
  hosts: "{{ target_host | default('all') }}"
  connection: local
  become: true

  tasks:
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
      when: ansible_os_family == "Debian"

    - name: Upgrade all packages to latest version
      ansible.builtin.apt:
        upgrade: dist
        autoremove: true
        autoclean: true
      when: ansible_os_family == "Debian"
      register: apt_upgrade_result

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file

    - name: Reboot the system if required
      ansible.builtin.shell: >
        nohup bash -c 'sleep 2 && shutdown -r now "Rebooting for weekly maintenance updates"' &
      async: 1
      poll: 0
      when:
        - reboot_required_file.stat.exists
        - maintenance_weekly_reboot_enabled | default(true)
