---
# Tasks for Chezmoi role
- name: Check if Chezmoi is already installed
  ansible.builtin.stat:
    path: "{{ chezmoi_install_path }}"
  register: chezmoi_binary

- name: Download Chezmoi binary
  ansible.builtin.get_url:
    url: "{{ chezmoi_binary_url }}"
    dest: "{{ chezmoi_install_path }}"
    mode: '0755'
  when: not chezmoi_binary.stat.exists

- name: Verify Chezmoi installation
  ansible.builtin.command: "{{ chezmoi_install_path }} --version"
  register: chezmoi_version_output
  changed_when: false

- name: Display Chezmoi version
  ansible.builtin.debug:
    msg: "Chezmoi version: {{ chezmoi_version_output.stdout }}"

- name: Get home directory for chezmoi_user
  ansible.builtin.getent:
    database: passwd
    key: "{{ chezmoi_user }}"
  register: getent_passwd
  when:
    - chezmoi_user is defined
    - chezmoi_repo_url | length > 0
    - chezmoi_init_apply

- name: Initialize Chezmoi with dotfiles repository
  become: true
  become_user: "{{ chezmoi_user }}"
  ansible.builtin.command: "{{ chezmoi_install_path }} init {{ chezmoi_repo_url }}"
  args:
    creates: >-
      {{ getent_passwd.ansible_facts.getent_passwd[chezmoi_user][4] }}/
      .local/share/chezmoi/.git
  when:
    - chezmoi_user is defined
    - chezmoi_repo_url | length > 0
    - chezmoi_init_apply
    - getent_passwd is defined
    - getent_passwd is succeeded
    - getent_passwd is not skipped

- name: Check if Homebrew prefix exists
  ansible.builtin.stat:
    path: /home/linuxbrew/.linuxbrew
  register: homebrew_prefix_stat
  when:
    - chezmoi_user is defined
    - chezmoi_init_apply

- name: Fix Homebrew permissions for chezmoi_user
  ansible.builtin.file:
    path: /home/linuxbrew/.linuxbrew
    state: directory
    owner: "{{ chezmoi_user }}"
    group: "{{ chezmoi_user }}"
    recurse: true
  when:
    - chezmoi_user is defined
    - chezmoi_init_apply
    - homebrew_prefix_stat.stat.exists | default(false)
  failed_when: false
  changed_when: false

- name: Apply Chezmoi dotfiles
  become: true
  become_user: "{{ chezmoi_user }}"
  ansible.builtin.command: "{{ chezmoi_install_path }} apply"
  when:
    - chezmoi_user is defined
    - chezmoi_repo_url | length > 0
    - chezmoi_init_apply
  register: chezmoi_apply
  changed_when: chezmoi_apply.stdout | length > 0
