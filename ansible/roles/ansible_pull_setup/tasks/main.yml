---
# Tasks for Ansible Pull Setup role
- name: Ensure ansible-pull workdir exists
  ansible.builtin.file:
    path: "{{ ansible_pull_workdir }}/ansible/scripts"
    state: directory
    mode: '0755'

- name: Copy ansible-pull script from repository
  ansible.builtin.copy:
    src: "{{ playbook_dir }}/../scripts/ansible-pull.sh"
    dest: "{{ ansible_pull_workdir }}/ansible/scripts/ansible-pull.sh"
    mode: '0755'

- name: Set up cron-based ansible-pull
  block:
    - name: Create cron job for ansible-pull
      ansible.builtin.cron:
        name: "Ansible pull - automated configuration"
        minute: "{{ ansible_pull_cron_schedule.split()[0] }}"
        hour: "{{ ansible_pull_cron_schedule.split()[1] }}"
        day: "{{ ansible_pull_cron_schedule.split()[2] }}"
        month: "{{ ansible_pull_cron_schedule.split()[3] }}"
        weekday: "{{ ansible_pull_cron_schedule.split()[4] }}"
        user: "{{ ansible_pull_user }}"
        job: >
          ANSIBLE_PULL_REPO_URL={{ ansible_pull_repo_url }}
          ANSIBLE_PULL_PLAYBOOK={{ ansible_pull_playbook }}
          ANSIBLE_PULL_INVENTORY={{ ansible_pull_inventory }}
          ANSIBLE_PULL_WORKDIR={{ ansible_pull_workdir }}
          ANSIBLE_PULL_LOG={{ ansible_pull_log_file }}
          {{ ansible_pull_workdir }}/ansible/scripts/ansible-pull.sh
        state: present
  when: ansible_pull_scheduler == "cron"

- name: Set up systemd-based ansible-pull
  block:
    - name: Create systemd service file
      ansible.builtin.template:
        src: ansible-pull.service.j2
        dest: /etc/systemd/system/ansible-pull.service
        mode: '0644'
      notify: Reload systemd

    - name: Create systemd timer file
      ansible.builtin.template:
        src: ansible-pull.timer.j2
        dest: /etc/systemd/system/ansible-pull.timer
        mode: '0644'
      notify: Reload systemd

    - name: Enable and start ansible-pull timer
      ansible.builtin.systemd_service:
        name: ansible-pull.timer
        enabled: true
        state: started
        daemon_reload: true
  when: ansible_pull_scheduler == "systemd"

- name: Display setup information
  ansible.builtin.debug:
    msg: >
      Ansible pull automation configured with {{ ansible_pull_scheduler }}.
      {% if ansible_pull_scheduler == 'systemd' %}
      Check status: sudo systemctl status ansible-pull.timer
      {% else %}
      Check cron: sudo crontab -l
      {% endif %}
