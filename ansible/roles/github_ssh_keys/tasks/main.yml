---
# Tasks for github_ssh_keys role
- name: Display warning about default GitHub username
  debug:
    msg: |
      WARNING: Using default GitHub username '{{ github_ssh_keys_username }}'.
      For security, you should change 'github_ssh_keys_username' to your own GitHub username
      in your host_vars or inventory configuration.
  when: github_ssh_keys_username == "DevSecNinja"
  tags: github_ssh_keys

- name: Ensure target user exists
  user:
    name: "{{ github_ssh_keys_target_user }}"
    state: present
  tags: github_ssh_keys

- name: Fetch SSH public keys from GitHub
  uri:
    url: "https://github.com/{{ github_ssh_keys_username }}.keys"
    return_content: true
    status_code: [200, 404]
  register: github_keys_response
  check_mode: false
  tags: github_ssh_keys

- name: Fail if GitHub user not found or no keys available
  fail:
    msg: "GitHub user '{{ github_ssh_keys_username }}' not found or has no public SSH keys"
  when: >
    github_keys_response.status == 404 or
    github_keys_response.content | default('') | trim == ''
  tags: github_ssh_keys

- name: Add SSH public keys from GitHub to authorized_keys
  authorized_key:
    user: "{{ github_ssh_keys_target_user }}"
    key: "{{ github_keys_response.content }}"
    exclusive: "{{ github_ssh_keys_exclusive }}"
    comment: "github:{{ github_ssh_keys_username }}"
  when: github_keys_response.status == 200 and github_keys_response.content | default('') | trim != ''
  tags: github_ssh_keys

- name: Display success message
  debug:
    msg: >-
      Successfully installed SSH keys from GitHub user
      '{{ github_ssh_keys_username }}' for user '{{ github_ssh_keys_target_user }}'
  tags: github_ssh_keys
