---
# Tasks for github_ssh_keys role
- name: Fail if GitHub username is not configured
  ansible.builtin.fail:
    msg: >-
      github_ssh_keys_username is not set. You must configure a GitHub
      username in your host_vars or inventory to use this role. Set it to
      your own GitHub username to fetch your public SSH keys.
  when: >
    github_ssh_keys_username is not defined or
    github_ssh_keys_username == ""
  tags: github_ssh_keys

- name: Ensure Target User Exists
  ansible.builtin.user:
    name: "{{ github_ssh_keys_target_user }}"
    state: present
  tags: github_ssh_keys

- name: Fetch SSH public keys from GitHub
  ansible.builtin.uri:
    url: "https://github.com/{{ github_ssh_keys_username }}.keys"
    return_content: true
    status_code: [200, 404]
  register: github_keys_response
  check_mode: false
  tags: github_ssh_keys

- name: Fail if GitHub user not found or no keys available
  ansible.builtin.fail:
    msg: >-
      GitHub user '{{ github_ssh_keys_username }}' not found or has no
      public SSH keys
  when: >
    github_keys_response.status == 404 or
    github_keys_response.content | default('') | trim == ''
  tags: github_ssh_keys

- name: Add SSH public keys from GitHub to authorized_keys
  ansible.posix.authorized_key:
    user: "{{ github_ssh_keys_target_user }}"
    key: "{{ github_keys_response.content }}"
    exclusive: "{{ github_ssh_keys_exclusive }}"
    comment: "github:{{ github_ssh_keys_username }}"
  when: >
    github_keys_response.status == 200 and
    github_keys_response.content | default('') | trim != ''
  tags: github_ssh_keys

- name: Display Success Message
  ansible.builtin.debug:
    msg: >-
      Successfully installed SSH keys from GitHub user
      '{{ github_ssh_keys_username }}' for user
      '{{ github_ssh_keys_target_user }}'
  tags: github_ssh_keys
